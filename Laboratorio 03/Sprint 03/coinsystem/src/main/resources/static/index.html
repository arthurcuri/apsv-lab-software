<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Coin System</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    nav { background:#333; color:#fff; padding:10px; }
    nav ul { list-style:none; margin:0; padding:0; display:flex; }
    nav li { margin-right:15px; cursor:pointer; }
    nav li.hidden { display:none; }
    .container { padding:20px; }
    section { display:none; }
    section.active { display:block; }
    form { max-width:400px; margin-bottom:20px; }
    form div { margin-bottom:10px; }
    label { display:block; margin-bottom:5px; }
    input, button { width:100%; padding:8px; box-sizing:border-box; }
    .message { margin-top:10px; color:green; }
    .error { color:red; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    .perfil { margin-bottom:20px; padding:10px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li data-section="login">Login</li>
      <li data-section="cadastrar-aluno">Cadastrar Aluno</li>
      <li data-section="cadastrar-professor">Cadastrar Professor</li>
      <li data-section="cadastrar-empresa">Cadastrar Empresa</li>
      <li data-section="dashboard-aluno" class="hidden">Dashboard Aluno</li>
      <li data-section="dashboard-professor" class="hidden">Dashboard Professor</li>
      <li data-section="dashboard-empresa" class="hidden">Dashboard Empresa</li>
      <li data-action="logout" class="hidden">Logout</li>
    </ul>
  </nav>

  <div class="container">
    <!-- Login -->
    <section id="login" class="active">
      <h2>Login</h2>
      <form id="login-form">
        <div><label>Email</label><input type="email" id="login-email" required></div>
        <div><label>Senha</label><input type="password" id="login-senha" required></div>
        <button type="submit">Entrar</button>
        <div id="login-msg" class="message"></div>
      </form>
    </section>

    <!-- Cadastrar Aluno -->
    <section id="cadastrar-aluno">
      <h2>Cadastrar Aluno</h2>
      <form id="aluno-form">
        <div><label>Nome</label><input type="text" id="aluno-nome" required></div>
        <div><label>Email</label><input type="email" id="aluno-email" required></div>
        <div><label>Senha</label><input type="password" id="aluno-senha" required></div>
        <div><label>CPF</label><input type="text" id="aluno-cpf" required></div>
        <div><label>Endereço</label><input type="text" id="aluno-endereco" required></div>
        <div><label>Instituição</label><input type="text" id="aluno-instituicao" required></div>
        <div><label>Curso</label><input type="text" id="aluno-curso" required></div>
        <button type="submit">Cadastrar</button>
        <div id="aluno-msg" class="message"></div>
      </form>
    </section>

    <!-- Cadastrar Professor -->
    <section id="cadastrar-professor">
      <h2>Cadastrar Professor</h2>
      <form id="professor-form">
        <div><label>Nome</label><input type="text" id="prof-nome" required></div>
        <div><label>Email</label><input type="email" id="prof-email" required></div>
        <div><label>Senha</label><input type="password" id="prof-senha" required></div>
        <div><label>CPF</label><input type="text" id="prof-cpf" required></div>
        <div><label>Departamento</label><input type="text" id="prof-depto" required></div>
        <button type="submit">Cadastrar</button>
        <div id="prof-msg" class="message"></div>
      </form>
    </section>

    <!-- Cadastrar Empresa -->
    <section id="cadastrar-empresa">
      <h2>Cadastrar Empresa</h2>
      <form id="empresa-form">
        <div><label>Nome</label><input type="text" id="emp-nome" required></div>
        <div><label>Email</label><input type="email" id="emp-email" required></div>
        <div><label>Senha</label><input type="password" id="emp-senha" required></div>
        <div><label>CNPJ</label><input type="text" id="emp-cnpj" required></div>
        <button type="submit">Cadastrar</button>
        <div id="emp-msg" class="message"></div>
      </form>
    </section>

    <!-- Dashboard Aluno -->
    <section id="dashboard-aluno">
      <div id="perfil-aluno" class="perfil"></div>
      <h2>Resgatar Vantagem</h2>
      <form id="resgatar-form">
        <div><label>ID Vantagem</label><input type="number" id="resgatar-vant-id" required></div>
        <button type="submit">Resgatar</button>
        <div id="resgatar-msg" class="message"></div>
      </form>
      <h2>Extrato de Transações</h2>
      <form id="extrato-form">
        <div><label>Data Início</label><input type="date" id="extrato-inicio" required></div>
        <div><label>Data Fim</label><input type="date" id="extrato-fim" required></div>
        <button type="submit">Buscar Extrato</button>
      </form>
      <div id="extrato-result"></div>
    </section>

    <!-- Dashboard Professor -->
    <section id="dashboard-professor">
      <div id="perfil-professor" class="perfil"></div>
      <h2>Distribuir Moedas</h2>
      <form id="distrib-form">
        <div><label>ID Aluno</label><input type="number" id="dist-aluno-id" required></div>
        <div><label>Quantidade</label><input type="number" id="dist-quantidade" required></div>
        <div><label>Mensagem</label><input type="text" id="dist-msg" required></div>
        <button type="submit">Distribuir</button>
        <div id="dist-msg-res" class="message"></div>
      </form>
    </section>

    <!-- Dashboard Empresa -->
    <section id="dashboard-empresa">
      <div id="perfil-empresa" class="perfil"></div>
      <h2>Cadastrar Vantagem</h2>
      <form id="vantagem-form">
        <div><label>Nome</label><input type="text" id="vant-nome" required></div>
        <div><label>Descrição</label><input type="text" id="vant-desc" required></div>
        <div><label>URL Imagem</label><input type="text" id="vant-img" required></div>
        <div><label>Custo</label><input type="number" id="vant-custo" required></div>
        <button type="submit">Cadastrar Vantagem</button>
        <div id="vant-msg" class="message"></div>
      </form>
    </section>
  </div>

  <script>
    let currentUser = null;

    const sections = document.querySelectorAll('section');
    const navItems = document.querySelectorAll('nav li');

    function showSection(id) {
      sections.forEach(s => s.id === id
        ? s.classList.add('active')
        : s.classList.remove('active')
      );
    }

    function updateNav() {
      navItems.forEach(li => {
        const sec = li.dataset.section;
        if (!currentUser) {
          // antes de login
          if (sec === 'login' || sec.startsWith('cadastrar-')) {
            li.classList.remove('hidden');
          } else {
            li.classList.add('hidden');
          }
          if (li.dataset.action === 'logout') li.classList.add('hidden');
        } else {
          // após login
          if (li.dataset.action === 'logout' ||
              li.dataset.section === `dashboard-${currentUser.tipo}`) {
            li.classList.remove('hidden');
          } else {
            li.classList.add('hidden');
          }
        }
      });
    }

    navItems.forEach(li => {
      if (li.dataset.section) {
        li.addEventListener('click', () => showSection(li.dataset.section));
      } else if (li.dataset.action === 'logout') {
        li.addEventListener('click', () => {
          currentUser = null;
          updateNav();
          showSection('login');
        });
      }
    });

    async function request(url, opts={}) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.status !== 204 ? await res.json() : null;
    }

    // Login
    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const form = new URLSearchParams();
      form.append('email', document.getElementById('login-email').value);
      form.append('senha', document.getElementById('login-senha').value);
      try {
        const user = await request('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        // definir tipo
        if ('curso' in user) user.tipo = 'aluno';
        else if ('departamento' in user) user.tipo = 'professor';
        else if ('cnpj' in user) user.tipo = 'empresa';
        currentUser = user;
        // preencher perfil
        document.getElementById(`perfil-${user.tipo}`).textContent =
          `Nome: ${user.nome} | Email: ${user.email} | Moedas: ${user.moedas}`;
        updateNav();
        showSection(`dashboard-${user.tipo}`);
      } catch (err) {
        document.getElementById('login-msg').textContent = err.message;
        document.getElementById('login-msg').classList.add('error');
      }
    });

    // Cadastro Aluno
    document.getElementById('aluno-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        nome: document.getElementById('aluno-nome').value,
        email: document.getElementById('aluno-email').value,
        senha: document.getElementById('aluno-senha').value,
        cpf: document.getElementById('aluno-cpf').value,
        endereco: document.getElementById('aluno-endereco').value,
        instituicaoEnsino: document.getElementById('aluno-instituicao').value,
        curso: document.getElementById('aluno-curso').value
      };
      try {
        await request('/api/alunos', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        document.getElementById('aluno-msg').textContent = 'Aluno cadastrado!';
      } catch (err) {
        document.getElementById('aluno-msg').textContent = err.message;
        document.getElementById('aluno-msg').classList.add('error');
      }
    });

    // Cadastro Professor
    document.getElementById('professor-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        nome: document.getElementById('prof-nome').value,
        email: document.getElementById('prof-email').value,
        senha: document.getElementById('prof-senha').value,
        cpf: document.getElementById('prof-cpf').value,
        departamento: document.getElementById('prof-depto').value
      };
      try {
        await request('/api/professores', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        document.getElementById('prof-msg').textContent = 'Professor cadastrado!';
      } catch (err) {
        document.getElementById('prof-msg').textContent = err.message;
        document.getElementById('prof-msg').classList.add('error');
      }
    });

    // Cadastro Empresa
    document.getElementById('empresa-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        nome: document.getElementById('emp-nome').value,
        email: document.getElementById('emp-email').value,
        senha: document.getElementById('emp-senha').value,
        cnpj: document.getElementById('emp-cnpj').value
      };
      try {
        await request('/api/empresas', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        document.getElementById('emp-msg').textContent = 'Empresa cadastrada!';
      } catch (err) {
        document.getElementById('emp-msg').textContent = err.message;
        document.getElementById('emp-msg').classList.add('error');
      }
    });

    // Resgatar Vantagem (Aluno)
    document.getElementById('resgatar-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        await request(
          `/api/alunos/${currentUser.id}/resgatar/${document.getElementById('resgatar-vant-id').value}`,
          {method:'POST'}
        );
        document.getElementById('resgatar-msg').textContent = 'Vantagem resgatada!';
      } catch (err) {
        document.getElementById('resgatar-msg').textContent = err.message;
        document.getElementById('resgatar-msg').classList.add('error');
      }
    });

    // Extrato (Aluno)
    document.getElementById('extrato-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const ext = await request(
          `/api/alunos/${currentUser.id}/extrato?inicio=${document.getElementById('extrato-inicio').value}&fim=${document.getElementById('extrato-fim').value}`
        );
        let html = '<table><thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Qtd</th></tr></thead><tbody>';
        ext.transacoes.forEach(tx => {
          html += `<tr><td>${new Date(tx.data).toLocaleString()}</td><td>${tx.tipo}</td><td>${tx.descricao}</td><td>${tx.quantidade}</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('extrato-result').innerHTML = html;
      } catch (err) {
        document.getElementById('extrato-result').textContent = err.message;
        document.getElementById('extrato-result').classList.add('error');
      }
    });

    // Distribuir Moedas (Professor)
    document.getElementById('distrib-form').addEventListener('submit', async e => {
      e.preventDefault();
      const alunoId = document.getElementById('dist-aluno-id').value;
      const quantidade = document.getElementById('dist-quantidade').value;
      const mensagem = encodeURIComponent(document.getElementById('dist-msg').value);
      try {
        await request(
          `/api/professores/${currentUser.id}/distribuir?alunoId=${alunoId}&quantidade=${quantidade}&mensagem=${mensagem}`,
          {method:'POST'}
        );
        document.getElementById('dist-msg-res').textContent = 'Moedas distribuídas!';
      } catch (err) {
        document.getElementById('dist-msg-res').textContent = err.message;
        document.getElementById('dist-msg-res').classList.add('error');
      }
    });

    // Cadastrar Vantagem (Empresa)
    document.getElementById('vantagem-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        nome: document.getElementById('vant-nome').value,
        descricao: document.getElementById('vant-desc').value,
        imagemUrl: document.getElementById('vant-img').value,
        custo: parseInt(document.getElementById('vant-custo').value, 10)
      };
      try {
        await request(
          `/api/empresas/${currentUser.id}/vantagens`,
          {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}
        );
        document.getElementById('vant-msg').textContent = 'Vantagem cadastrada!';
      } catch (err) {
        document.getElementById('vant-msg').textContent = err.message;
        document.getElementById('vant-msg').classList.add('error');
      }
    });
  </script>
</body>
</html>
